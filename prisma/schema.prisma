generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  stocks    Stock[]
  settings  Settings[]
  createdAt DateTime @default(now())
}

model Settings {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  annualRate  Float    @default(15.0) // Annual interest rate in percentage
  buyStep     Float    @default(3.5)  // Buy step in percentage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Stock {
  id           Int           @id @default(autoincrement())
  userId       Int
  user         User          @relation(fields: [userId], references: [id])
  symbol       String        // Removed @unique because different users can hold same stock
  name         String        // e.g., "分众传媒"
  annualRate       Float?        // Overrides global setting if present
  buyStep          Float?        // Overrides global setting if present
  maxInvestment    Float?        // Optional max investment limit
  lastDividendDate DateTime?     // The date of the last applied dividend
  transactions     Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([userId, symbol]) // Ensure a user can only add a stock once
}

model Transaction {
  id          Int      @id @default(autoincrement())
  stockId     Int
  stock       Stock    @relation(fields: [stockId], references: [id], onDelete: Cascade)
  
  type        String   // "BUY" or "SELL"
  price       Float
  quantity    Int
  date        DateTime @default(now())
  
  // For tracking the "chain" of trades
  relatedTransactionId Int? // If this is a SELL, which BUY does it close?
  
  isVirtual   Boolean  @default(false) // For the "Virtual Trading" feature
  status      String   @default("OPEN") // OPEN (holding), CLOSED (sold)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
